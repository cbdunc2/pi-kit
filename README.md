# pi-kit
Turn a RaspberryPi 3 B into an Apple HomeKit bridge in order to control RF controlled outlets with Siri.

# Required Materials
<a target="_blank" href="https://www.amazon.com/gp/product/B01CD5VC92/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=B01CD5VC92&linkCode=as2&tag=camero013-20&linkId=d57cc185cf9f41625bcf6976d1feb794">Raspberry Pi 3 Model B</a><img src="//ir-na.amazon-adsystem.com/e/ir?t=camero013-20&l=am2&o=1&a=B01CD5VC92" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /> - $35.70<br>
<a target="_blank" href="https://www.amazon.com/gp/product/B00DQ2KGNK/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=B00DQ2KGNK&linkCode=as2&tag=camero013-20&linkId=f1f978482acbe54ded5dbf80542d48ce">3X RF Controlled Outlets</a><img src="//ir-na.amazon-adsystem.com/e/ir?t=camero013-20&l=am2&o=1&a=B00DQ2KGNK" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /> - $19.98 <br>
<a target="_blank" href="https://www.amazon.com/gp/product/B00RFQ11PU/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=B00RFQ11PU&linkCode=as2&tag=camero013-20&linkId=9b63367d8ed1b09b9e08e2e5a224063f">RF Transmitter &amp; Receiver Kit</a><img src="//ir-na.amazon-adsystem.com/e/ir?t=camero013-20&l=am2&o=1&a=B00RFQ11PU" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /> - $7.91 <br>
<a target="_blank" href="https://www.amazon.com/gp/product/B01GZKOJN2/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=B01GZKOJN2&linkCode=as2&tag=camero013-20&linkId=756cff1b2bb2337b673cde28767e642a">Breadboard + Mounting Plate</a><img src="//ir-na.amazon-adsystem.com/e/ir?t=camero013-20&l=am2&o=1&a=B01GZKOJN2" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /> - $10.99 <br>
<a target="_blank" href="https://www.amazon.com/gp/product/B008MRZSH8/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=B008MRZSH8&linkCode=as2&tag=camero013-20&linkId=5de1ad8851f4482fc38f0d12f5c10df4">Jumper Wires 20cm M/F </a><img src="//ir-na.amazon-adsystem.com/e/ir?t=camero013-20&l=am2&o=1&a=B008MRZSH8" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /> - $5.86 <br>
<a target="_blank" href="https://www.amazon.com/gp/product/B004ZIENBA/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=B004ZIENBA&linkCode=as2&tag=camero013-20&linkId=482b7a072e66f47d0a7bd9cd046e467c">16GB MicroSD Card + Adapter</a><img src="//ir-na.amazon-adsystem.com/e/ir?t=camero013-20&l=am2&o=1&a=B004ZIENBA" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /> - $5.95 <br>
<a target="_blank" href="https://www.amazon.com/gp/product/B01IHU0CEI/ref=as_li_tl?ie=UTF8&camp=1789&creative=9325&creativeASIN=B01IHU0CEI&linkCode=as2&tag=camero013-20&linkId=0f4a3da314c16c300d3213133174b8ef">Micro USB Cable + Wall Adapter</a><img src="//ir-na.amazon-adsystem.com/e/ir?t=camero013-20&l=am2&o=1&a=B01IHU0CEI" width="1" height="1" border="0" alt="" style="border:none !important; margin:0px !important;" /> - $6.99<br>
FREE Borrow a USB Keyboard/Mouse and an HDMI Monitor from a friend or another computer. <br>
FREE Whatever Dumb thing you want to be smart! <br>

# Step 1: Set-Up your Pi
Many of the guides I have found on this subject assume you are a native to RasperryPi and know how to get everything set-up. However, I will not assume that here, and will walk you through the general set-up of a RaspberryPi - so let's get started. <br>
<ul>
  <li>Download the lastest version of the NOOB installer from <a href="http://downloads.raspberrypi.org/NOOBS_latest">here</a></li>
  <li>Insert your microSD card into it's adapter, and insert the whole thing into the SD card reader on your computer. Open up Disk Utility (on Mac) or similar software on Windows. Click to erase and format the disk - select the option FAT.</li>
  <li>Unzip and copy all the files from the NOOB download onto your SD card. Once finished, eject the SD card from your computer - now we are ready to get started on the Pi.</li>
  <li>Remove the microSD card from it's adapter and insert it into the Pi. Now, plug in your USB Keyboard/Mouse, HDMI monitor and the Pi's power cord - it should boot into the installer! Select Raspbian and click install.</li>
  <li>Once the Pi has booted into </li>
</ul>

pi-kit

Turn a RaspberryPi 3 B into an Apple HomeKit bridge in order to control RF controlled outlets with Siri.

Required Materials

Raspberry Pi 3 Model B - $35.70
3X RF Controlled Outlets - $19.98 
RF Transmitter & Receiver Kit - $7.91 
Breadboard + Mounting Plate - $10.99 
Jumper Wires 20cm M/F  - $5.86 
16GB MicroSD Card + Adapter - $5.95 
Micro USB Cable + Wall Adapter - $6.99
FREE Borrow a USB Keyboard/Mouse and an HDMI Monitor from a friend or another computer. 
FREE Whatever Dumb thing you want to be smart! 

Step 1: Set-Up your Pi

Many of the guides I have found on this subject assume you are a native to RasperryPi and know how to get everything set-up. However, I will not assume that here, and will walk you through the general set-up of a RaspberryPi - so let's get started. 

Download the lastest version of the NOOB installer from here
Insert your microSD card into it's adapter, and insert the whole thing into the SD card reader on your computer. Open up Disk Utility (on Mac) or similar software on Windows. Click to erase and format the disk - select the option FAT.
Unzip and copy all the files from the NOOB download onto your SD card. Once finished, eject the SD card from your computer - now we are ready to get started on the Pi.
Remove the microSD card from it's adapter and insert it into the Pi. Now, plug in your USB Keyboard/Mouse, HDMI monitor and the Pi's power cord - it should boot into the installer! Select Raspbian and whichever language you would like to work in, and click install.
A warning will pop-up letting you know installation of Rasbian Jessie will overwrite the other files on the SD card, click yes.
Be patient while the OS installs… This should take about 20 minutes. If the progress bar hasn’t changed in a few minutes your pi may have froze - if you can't stand it anymore then unplug a repeat steps 4 and 5.
Once the Pi has finished installing a pop-up will appear letting you know installation was successful. Click ok and the pi should boot into the desktop.
Next we need to connect to wifi. Click the second icon from the left in the upper right hand corner (next to bluetooth). Select your home wifi address and type in the password. Test your internet connection by opening up the browser.
The last thing we need to complete in setting up our pi is to set-up SSH. Open terminal and run the following comand:
	$ sudo raspi-config
Tab down to advanced options and hit enter.
Next, tab down to ssh click enter and select enable SSH. Voila!


Step 2 (Optional): Set-Up SSH

Note: from now on you can do these steps with your RaspberryPi plugged into the screen (Screen mode) or vis SSH (Headless Mode). In order to set-up ssh, follow the instructions below.

In order to set-up headless mode via SSH we are going to need to know the hostname, IP address and password. By default, the hostname and password for RaspberryPi are pi and raspberry respectively. The IP address is a bit more complicated…

Mac/Linux

On Mac and Linux SSH is relatively easy. By default you don’t need to know your pi’s IP address because you can connect to it locally in terminal. Open terminal and enter the following to connect to your pi:
$ ssh pi@raspberrypi.local
Enter the default password, raspberry
	$ raspberry

Windows

On Windows I believe you will need to know the exact IP address of your pi. The easiest way to find your pi’s IP address is by running the following command while still connected to your display.
$ ifconfig

If you have already disconnected from your display don’t fret. If you’re using an AirPort router, just open airport utility, highlight your device and then hover over raspberrypi under wireless clients. If you’re not using an airport, look on the label of your router. You should find an IP address for your home network. Navigate to that address in your browser and you should be able to find a list of connected devices there.

Now open your SSH client (like PuTTY) and type the following command:
$ ssh pi@ipaddress
Enter the default password, raspberry
	$ raspberry

Step 3: Install Node, HAP-NodeJS and Dependencies

In order to install these directories and applications globally we need to be running SSH in root. To do this run the following command in terminal:
	$ sudo su
Now we need to update the latest package lists to install the software in the following steps 
	$  apt-get update
Next lets install some dependencies for Node
	$ apt-get install git-core libnss-mdns libavahi-compat-libdnssd-dev -y
Finally, we can retrieve node from a Heroku Distribution and un-package it.
	$ wget http://node-arm.herokuapp.com/node_latest_armhf.deb
$ dpkg -i node_latest_armhf.deb
** You may encounter this error:

dpkg: error processing archive node_0.10.36_armhf.deb (--install):conflicting packages - not installing node

If you do it’s because your NOOB distribution included an outdated version of Node. Run the following commands to remove Node from your pi and repeat step 4.
	$ sudo apt-get remove nodered
$ sudo apt-get remove nodejs nodejs-legacy	
Now, let’s check to make sure Node and Node Package Manager (NPM) installed correctly by checking their version:
$ sudo node -v
$ sudo npm -v
As of writing this tutorial, the current node and npm versions are 4.2.1 and 2.14.7 respectively.

Next we will install the node add-on build tool, node-gyp, so that we can install the HAP-NodeJS add-on.
$ npm install -g node-gyp 
Now let’s install some modules the HAP-NodeJS server will require:
$ npm install -g node-gyp && npm install python-shell && npm install node-persist && npm install srp && npm install mdns && npm install ed25519 && npm install curve25519 && npm install debug
Finally we can install HAP-NodeJS which will allow us to run a server that will act as a bridge between our pi and Apple’s HomeKit and Siri.
$ git clone https://github.com/KhaosT/HAP-NodeJS.git
Step 4: Running and Checking our Server

In order to test whether the bridge is working, we first need to change into the HAP-NodeJS directory.
$ cd Hap-NodeJS
Next, let’s rebuild NPM
$ npm rebuild
And run the server!
$ sudo node BridgedCore.js
** You may encounter this error or a similar one with a missing module:

Error: Cannot find module ‘module-name‘

To fix this, run the following command replacing module-name with whichever module you are missing:
$ npm install module-name
This may continue to happen until you have installed all the necessary dependencies for HAP-NodeJS… just repeat the individual installation with each remaining module. The output should then look like this with some warnings:

HAP-NodeJS starting...
Parsing accessory: Fan_accessory.js
Parsing accessory: GarageDoorOpener_accessory.js
Parsing accessory: Light_accessory.js
Parsing accessory: Lock_accessory.js
Parsing accessory: MotionSensor_accessory.js
Parsing accessory: Outlet_accessory.js
Parsing accessory: TemperatureSensor_accessory.js
Parsing accessory: Thermostat_accessory.js

Now let’s make sure your phone and the Bridge can speak to each other. Open “Home” on your iPhone and click add accessory - if you see Node Bridge then we can move onto the next step! 

Step 5: Setting-Up Pilight

Now that we have our HomeKit server set-up and running, we need to build the backend to control the RF Outlets with HomeKit. This backend will be comprised of two parts: a shell script that sends the on/off signal and a python script that connects the shell command with our HomeKit server.

First let’s change back to our user directory, pi with the following command:
	$ cd ..
Next lets install some dependencies that python and plight will need (Note: we should still be in root - root@raspberrypi… if that is not what you see in terminal enter sudo su).
	$ nano /etc/apt/sources.list
Now let’s tell our pi where it should find the pilight repository. Enter the following command:
	$ apt-get install python-dev python-pip
Below the last line enter the following and save and exit:
	deb http://apt.pilight.org/ stable main
We can now install pilight with the apt-get function - first we need to update it’s source list and then we can install:
	$ apt-get update
	$ apt-get install pilight
Now let’s run pilight in the background (as a daemon):
	$ sudo pilight-daemon

Step 6: Setting-Up the Hardware

So we’ve got our server running and pilight installed - now we need to set-up the transmitter and receiver so we can sniff out the RF codes and test our scripts! There are two main options for setting up the hardware.

Breadboard
Using a breadboard is great for beginners! It is completely plug-in-play and requires NO soldering. Even if you end up soldering in the end I would suggest getting started with a breadboard to make sure everything works.

Soldering
Soldering uses metal with a low-melting point to directly adhere wires to the terminals on the receiver/transmitter. While soldering is definitely better for post-production and making your project cleaner, it requires a steady hand, patience and knowing or research on how to do it. 

Whichever way you elect to proceed with you need to connect power, data and a ground to each the receiver and the transmitter. The main difference between wiring the transmitter and receiver is that the receiver requires 3.3V instead of the 5V of power the transmitter requires. Follow the diagrams included and you’ll be A OK!

** Note: when you solder remember you are soldering on the underside of the pins, so the diagram would be flipped!

Step 7: Sniffing out the RF Codes

Sweet! Now that we’ve got all our hardware set-up we can get started on figuring out what RF code flips each outlet. 
** Note: Repeat the following steps for each outlet you elect to set-up!

Add the batteries to the remote that controls your RF outlets and bring it close to the pi and receiver. Run the following command and press the “on” button for the outlet you’re setting up.
	$ pilight-receive
** Note: if you get the error "no pilight-ssdp sessions found” it means that pilight is not running in the background. Run the following command again and it should work.
	$ sudo pilight-daemon
You should get something like the following output:

{
	"message": {
		"id": "A2",
		"unit": 10,
		"state": "on"
	},
	"origin": "receiver",
	"protocol": "clarus_switch",
	"uuid": "0000-b8-27-eb-f33832",
	"repeats": 1
}

Sweet, right? Now what are worried about in controlling each outlet is the id, unit and protocol. On a piece of paper record these values for each outlet you wish to control. 

For my switches/outlets I would write:

Step 8: Writing our RF Send Scripts

You must be thinking “Ugh I wanted to code something what’s going on??” right? Hah! Now is your time to shine - here we will write on and off shell scripts for each outlet that will mimic how your remote works - let’s go!

The first thing we need to do is make a directory to store our RF Send for our user:
** Note: Make sure you are in the home directory of your user (“pi”). 
	$ mkdir Switches
Now that we have a directory to store our scripts in it’s time to make some magic. Navigate to the directory you just made and create our first On file.
$ cd Switches
$ nano Switch1_On.sh
Once inside the file write the following script, changing the protocol, id and unit for the ones you recorded in step 7.2:
$ sudo pilight-send -p [protocol] -i [id] -u [unit] -t
sudo pilight-send -p clarus_switch -i A2 -u 10 -t
** What does this mean? Well a shell script is just a command inside of a file - just like you would write in terminal. Sudo sends the command as root, pilight-send calls the command send from our pilight application, and the -p -i and -u tags designate which outlet to send the command to. Finally, the -t attribute tells the switch to turn on, whereas -f would tell the switch to turn off.

Now save the file and exit with ctrl+x.

Now let’s make that shell script executable by running the following command:
$ sudo chmod +x Switch1_On.sh
So now we have a script that will turn Outlet 1 on - how do we make it turn off? Easy! Copy the same file, enter it and replace -t with -f (copying the file copies the executable attribute so we don’t have to run chmod again):
$ cp Switch1_On.sh Switch1_Off.sh
$ nano Switch1_Off.sh
sudo pilight-send -p [protocol] -i [id] -u [unit] -f
Sweet - now before repeating steps 1-5 for each switch let’s make sure it works. Plug in outlet 1 and run the following commands:
$ sudo ./Switch1_On.sh
$ sudo ./Switch1_Off.sh
I hope you just let out a yelp of excitement! Now that we have one outlet working, setting-up the rest of the outlets is a breeze by copying each on/off script and editing the protocol, id and unit attributes for each outlet like so:
$ cp Switch1_On.sh Switch2_On.sh
$ cp Switch1_Off.sh Switch2_Off.sh
$ nano Switch2_On.sh
$ nano Switch2_Off.sh
Step 9: Writing our Python RF Send Scripts Controllers
 
If you’re wondering why we are creating an additional script that will be triggered to trigger a switch you’re getting the hang of this. However, as our friend BrendanC1 over at Instructables figured out, NodeJS applications act a bit funky when triggering shell scripts, but work perfectly fine when triggering python scripts - so we are going to be safe and create python controllers.

First we need to get back into our HAP-NodeJS folder:
$ cd ..
$ cd HAP-NodeJS
Once there we can begin creating and entering the python controller for our first outlet with the syntax light[outlet_number]_[On/Off].
$ sudo nano Light1_On.py
Now let’s write the python to trigger our executable on script for outlet 1, exit and save:
#!/usr/bin/python
import subprocess
subprocess.Popen([‘sh', ‘../Switches/Switch1_On.sh’])
Make our python controller executable:
$ sudo chmod a+x Light1_On.py
Copy the Light1_On.py to create Light1_Off.py, enter it and change Switch1_On to Switch1_Off:
$ sudo cp Light1_On.py Light1_Off.py
$ sudo nano Light1_Off.py
subprocess.Popen(['sh', ‘../Switches/Switch1_Off.sh’])
Repeat what we did in 8.7 but change out Switch1_On/Off with Switch2_On/Off etc. in our controller scripts:
$ sudo cp Light1_On.py Light2_On.py
$ sudo cp Light1_Off.py Light2_Off.py
$ sudo nano Light2_On.py
$ sudo nano Light2_Off.py

Step 10: Connecting our Python Controllers with HomeKit Accessories

Great - so now we have scripts that can turn on/off our RF switches and controllers for those switches, but how do we make the “Hey Siri turn on my lights” magic work? By creating an artificial “Accessory” for each outlet (light) that we have - let’s get to it.

First we need to prepare each accessory by generating and recording MAC (Media Access Control) addresses for each outlet. We can do that here. Be sure to change the MAC address format to colon:based and the case to Uppercase. Here is what I got:

Now, in order to edit and create the accessory files, we need to change directories into the HAP-NodeJS/accessories directory:
$ cd accessories
Let’s edit the default Outlet_accessory.js file for out first outlet:
$ sudo nano Outlet_accessory.js
Before the first line in the file paste the following code that tells our scripts to require python functionality:
	var PythonShell = require('python-shell');
Locate the Variable var Fake_Outlet . This variable says that when a user turns the accessory on with HomeKit [if (on)] then it will log on but won’t trigger any scripts - the same thing goes for turning it off  [else] - and we need to change that. Replace the whole variable line (down until the // comment) with the following code:

var FAKE_OUTLET = {
    setPowerOn: function(on) { 
    console.log("Turning the outlet %s!...", on ? "on" : "off");
    if (on) {
          FAKE_OUTLET.powerOn = true;
          if(err) { return console.log(err); }
          PythonShell.run('Switch1_On.py', function (err) {
          console.log("...outlet is now on.");          
    });
    } else {
          FAKE_OUTLET.powerOn = false;
          if(err) { return console.log(err); }
          PythonShell.run('Switch1_Off.py', function (err) {
          console.log("...outlet is now off.");
    });
  }
  },
    identify: function() {
    console.log("Identify the outlet.");
    }
}

As you can see, we’ve now added a line that triggers the on and off python controllers we wrote in step 9 when a user toggles the accessory on and off with home kit - wohoo!

Locate the line that says var outletUUID. Replace the third attribute (outlet by default) by the number of your outlet (One, Two or Three - ** in words).
	var outletUUID = uuid.generate('hap-nodejs:accessories:One');
Locate the line that says outlet.username - 2-3 sections down from the last step. Change the username to whatever we generated in 10.1. Once done, exit and save the file.
outlet.username = “MAC_Address”;
outlet.username = “01:79:35:10:FE:88”; for me.
Rename the default accessory from Outlet_accessory.js to One_accessory.js:
	$ mv Outlet_accessory.js One_accessory.js
Now we need to copy that accessory file for each outlet and change the python controllers it triggers, UUID variable and the unique MAC address.
	$ sudo cp One_accessory.js Two_accessory.js
$ sudo nano Two_accessory.js
Switch2_On.py
Switch2_Off.py
var outletUUID = uuid.generate('hap-nodejs:accessories:Two');
outlet.username = “MAC_Address”;
Repeat for Outlet 3!

Remove the default accessories that we don’t need:
	$ rm Fan_accessory.js GarageDoorOpener_accessory.js Light_accessory.js Lock_accessory.js MotionSensor_accessory.js TemperatureSensor_accessory.js Thermostat_accessory.js
Step 11: Setting Up Apple Home and Siri

First we need to change back to the root HAP-NodeJS directory
	$ cd ..
Now we can run the server again with our completed accessories!
	$ sudo node BridgedCore.js
**If you get a module error for python-shell, go ahead and install it with apt-get:
	$ npm install python-shell
Open “Home” and click add accessory. Node-Bridge should show up - if not make sure your persist folder is clear by running rm persist/*. Click add accessory anyway and enter code manually. Enter code:
	031-45-154
Name your outlets whatever you would like Siri to respond to and specify their type (Lights or lights, outlets for misc etc.).

Try it out!

Step 12: Running HapNode-JS  and PiLight Daemon on Boot

Now we have our server working and our switches triggered by Siri! But if we need to unplug the pi we don’t want to have to run the server over and over again - this is where PM2 comes into play.

Install PM2
	$ sudo npm install pm2 -g
Generate Start-Up Script
	$ sudo pm2 startup
Run BridgedCore.js with PM2
	$ sudo pm2 start BridgedCore.js
Save PM2 scripts to start on boot
	$ sudo pm2 save
Often times Pilight-Daemon won’t start on boot because it tried starting before the network has loaded. Thus, we need to tell it to wait 10 seconds before it starts on boot. From a fresh SSH session or the root directory of your user enter the following commands:
	$ cd ..
	$ cd ..
	$ sudo nano  /etc/init.d/pilight

Once inside the pilight initialization script, scroll until you see do_start (around line 81) and paste the following right before it:
	sleep 10
Reboot your pi and make sure everything works. Voila! You’ve got Siri-Controlled RF Outlets. Have fun impressing your friends and family.
